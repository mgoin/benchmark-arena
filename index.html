<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Performance Benchmark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chat-message {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-bar {
            transition: width 0.3s ease-in-out;
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .highlight {
            animation: highlight 2s ease-in-out;
        }

        @keyframes highlight {
            0% {
                background-color: rgba(255, 255, 0, 0.1);
            }

            100% {
                background-color: transparent;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">LLM Performance Benchmark</h1>
            <div class="flex space-x-4">
                <button id="reset-btn"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">
                    <i class="fas fa-redo mr-2"></i>Reset
                </button>
                <button id="history-btn"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                    <i class="fas fa-history mr-2"></i>History
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <!-- Tabs -->
        <div class="flex space-x-4 mb-6">
            <button id="tab-chat" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Chat</button>
            <button id="tab-setup"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Setup</button>
            <button id="tab-history"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">History</button>
        </div>
        <!-- Setup Section -->
        <div id="setup-section" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-medium text-gray-900 mb-3">Configuration</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Baseline URL</label>
                            <input type="text" id="baseline-url" value="http://localhost:9000/v1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Quantized URL</label>
                            <input type="text" id="quantized-url" value="http://localhost:9001/v1"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Temperature</label>
                            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7"
                                class="mt-1 block w-full">
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>0</span>
                                <span>0.7</span>
                                <span>2</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Max Tokens</label>
                            <input type="number" id="max-tokens" value="1024"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button id="connect-btn"
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition text-sm">
                            <i class="fas fa-plug mr-2"></i>Connect to Models
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- History Section -->
        <div id="history-section" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-medium text-gray-900 mb-3">Benchmark History</h2>
                <div class="overflow-auto max-h-96">
                    <table class="min-w-full table-auto text-sm">
                        <thead>
                            <tr>
                                <th class="px-2 py-1 text-left">Time</th>
                                <th class="px-2 py-1 text-left">Baseline ITL (ms)</th>
                                <th class="px-2 py-1 text-left">Quantized ITL (ms)</th>
                                <th class="px-2 py-1 text-left">Baseline t/s</th>
                                <th class="px-2 py-1 text-left">Quantized t/s</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Chat Section -->
        <div id="chat-section">
            <!-- Summary Statistics -->
            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-medium text-gray-900 mb-3">Performance Summary</h2>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <div class="stat-card bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <div class="text-sm font-medium text-blue-800">Speed</div>
                        <div id="speed-improvement" class="text-xl font-bold text-blue-900">-</div>
                        <div class="text-xs text-blue-600">Tokens/second</div>
                    </div>
                    <div class="stat-card bg-green-50 p-3 rounded-lg border border-green-100">
                        <div class="text-sm font-medium text-green-800">TTFT</div>
                        <div id="ttft-improvement" class="text-xl font-bold text-green-900">-</div>
                        <div class="text-xs text-green-600">First token</div>
                    </div>
                    <div class="stat-card bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                        <div class="text-sm font-medium text-yellow-800">ITL</div>
                        <div id="itl-improvement" class="text-xl font-bold text-yellow-900">-</div>
                        <div class="text-xs text-yellow-600">Token latency</div>
                    </div>
                </div>
                <div>
                    <canvas id="performance-chart" height="120"></canvas>
                </div>
            </div>

            <!-- Chat Comparison -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Baseline Model -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="bg-gray-800 text-white px-4 py-3 flex justify-between items-center">
                        <div>
                            <span id="baseline-model-name" class="font-medium">Baseline Model</span>
                            <span id="baseline-model-size" class="text-xs text-gray-300 ml-2">-</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="baseline-status"
                                class="text-xs px-2 py-1 rounded-full bg-gray-600">Disconnected</span>
                        </div>
                    </div>
                    <div id="baseline-chat" class="h-96 overflow-y-auto p-4 space-y-4 bg-gray-50">
                        <div class="text-center text-gray-500 py-10">
                            <i class="fas fa-robot text-4xl mb-2"></i>
                            <p>Connect to baseline model to start benchmarking</p>
                        </div>
                    </div>
                    <div class="bg-gray-100 px-4 py-2 border-t border-gray-200">
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div>
                                <div class="text-gray-500">TTFT</div>
                                <div id="baseline-ttft" class="font-medium">- ms</div>
                            </div>
                            <div>
                                <div class="text-gray-500">ITL</div>
                                <div id="baseline-itl" class="font-medium">- ms</div>
                            </div>
                            <div>
                                <div class="text-gray-500">Throughput</div>
                                <div id="baseline-throughput" class="font-medium">- t/s</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quantized Model -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="bg-red-800 text-white px-4 py-3 flex justify-between items-center">
                        <div>
                            <span id="quantized-model-name" class="font-medium">Quantized Model</span>
                            <span id="quantized-model-size" class="text-xs text-red-300 ml-2">-</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span id="quantized-status"
                                class="text-xs px-2 py-1 rounded-full bg-red-600">Disconnected</span>
                        </div>
                    </div>
                    <div id="quantized-chat" class="h-96 overflow-y-auto p-4 space-y-4 bg-red-50">
                        <div class="text-center text-red-500 py-10">
                            <i class="fas fa-bolt text-4xl mb-2"></i>
                            <p>Connect to quantized model to start benchmarking</p>
                        </div>
                    </div>
                    <div class="bg-red-100 px-4 py-2 border-t border-red-200">
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div>
                                <div class="text-red-500">TTFT</div>
                                <div id="quantized-ttft" class="font-medium">- ms</div>
                            </div>
                            <div>
                                <div class="text-red-500">ITL</div>
                                <div id="quantized-itl" class="font-medium">- ms</div>
                            </div>
                            <div>
                                <div class="text-red-500">Throughput</div>
                                <div id="quantized-throughput" class="font-medium">- t/s</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex space-x-4">
                    <div class="flex-grow">
                        <textarea id="user-input" rows="2"
                            class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border"
                            placeholder="Type your message here..."></textarea>
                    </div>
                    <div>
                        <button id="send-btn"
                            class="h-full bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition disabled:opacity-50"
                            disabled>
                            <i class="fas fa-paper-plane mr-2"></i>Send
                        </button>
                    </div>
                </div>
                <div class="mt-2 flex justify-between items-center text-xs text-gray-500">
                    <div>
                        <span id="token-count">0</span> tokens
                    </div>
                    <div class="flex items-center space-x-2">
                        <span>Streaming:</span>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="stream-toggle" checked
                                class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2">Enabled</span>
                        </label>
                    </div>
                </div>
            </div>
        </div> <!-- end chat-section -->
    </main>

    <script>
        // Global variables
        let baselineStats = {
            model: null,
            size: null,
            connected: false,
            ttft: null,
            itl: null,
            throughput: null,
            tokens: 0,
            startTime: null,
            lastTokenTime: null
        };

        let quantizedStats = {
            model: null,
            size: null,
            connected: false,
            ttft: null,
            itl: null,
            throughput: null,
            tokens: 0,
            startTime: null,
            lastTokenTime: null
        };

        let performanceChart = null;
        let chatHistory = [];

        // DOM elements
        const connectBtn = document.getElementById('connect-btn');
        const sendBtn = document.getElementById('send-btn');
        const resetBtn = document.getElementById('reset-btn');
        const historyBtn = document.getElementById('history-btn');
        const userInput = document.getElementById('user-input');
        const baselineChat = document.getElementById('baseline-chat');
        const quantizedChat = document.getElementById('quantized-chat');
        const streamToggle = document.getElementById('stream-toggle');

        // Initialize the performance chart
        function initPerformanceChart() {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Baseline ITL',
                            data: [],
                            borderColor: 'rgba(75, 85, 99, 1)',
                            backgroundColor: 'transparent',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Quantized ITL',
                            data: [],
                            borderColor: 'rgba(204, 0, 0, 1)',
                            backgroundColor: 'transparent',
                            yAxisID: 'y'
                        },
                        {
                            label: 'Baseline t/s',
                            data: [],
                            borderColor: 'rgba(75, 85, 99, 0.6)',
                            backgroundColor: 'transparent',
                            yAxisID: 'throughput-axis'
                        },
                        {
                            label: 'Quantized t/s',
                            data: [],
                            borderColor: 'rgba(204, 0, 0, 0.6)',
                            backgroundColor: 'transparent',
                            yAxisID: 'throughput-axis'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    stacked: false,
                    scales: {
                        x: { title: { display: true, text: 'Request #' } },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'ITL (ms)' }
                        },
                        'throughput-axis': {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Throughput (tokens/s)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // Tab switching logic
        const tabChatBtn = document.getElementById('tab-chat');
        const tabSetupBtn = document.getElementById('tab-setup');
        const tabHistoryBtn = document.getElementById('tab-history');

        function switchTab(tab) {
            ['chat', 'setup', 'history'].forEach(name => {
                const sec = document.getElementById(`${name}-section`);
                if (sec) sec.classList.toggle('hidden', name !== tab);
                const btn = document.getElementById(`tab-${name}`);
                if (btn) {
                    btn.classList.toggle('bg-blue-600', name === tab);
                    btn.classList.toggle('text-white', name === tab);
                    btn.classList.toggle('bg-gray-200', name !== tab);
                    btn.classList.toggle('text-gray-800', name !== tab);
                }
            });
            // When switching to history, render the table
            if (tab === 'history') renderHistoryTable();
        }

        // Default to chat tab
        switchTab('chat');

        // Tab button handlers
        if (tabChatBtn) tabChatBtn.addEventListener('click', () => switchTab('chat'));
        if (tabSetupBtn) tabSetupBtn.addEventListener('click', () => switchTab('setup'));
        if (tabHistoryBtn) tabHistoryBtn.addEventListener('click', () => switchTab('history'));
        // Render history table when needed
        function renderHistoryTable() {
            const history = JSON.parse(localStorage.getItem('benchmark_history') || '[]');
            const tbody = document.getElementById('history-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            history.forEach(entry => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-2 py-1">${entry.timestamp}</td>
                    <td class="px-2 py-1">${entry.baseline_itl.toFixed(2)}</td>
                    <td class="px-2 py-1">${entry.quantized_itl.toFixed(2)}</td>
                    <td class="px-2 py-1">${entry.baseline_throughput.toFixed(2)}</td>
                    <td class="px-2 py-1">${entry.quantized_throughput.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Connect to models
        async function connectToModels() {
            const baselineUrl = document.getElementById('baseline-url').value;
            const quantizedUrl = document.getElementById('quantized-url').value;

            if (!baselineUrl || !quantizedUrl) {
                alert('Please enter both model URLs');
                return;
            }

            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';

            try {
                // Connect to baseline model
                const baselineResponse = await fetch(`${baselineUrl}/models`);
                const baselineData = await baselineResponse.json();
                baselineStats.model = baselineData.data[0].id;
                baselineStats.size = baselineData.data[0].size || 'Unknown';
                baselineStats.connected = true;

                document.getElementById('baseline-model-name').textContent = baselineStats.model;
                document.getElementById('baseline-model-size').textContent = baselineStats.size;
                document.getElementById('baseline-status').textContent = 'Connected';
                document.getElementById('baseline-status').className = 'text-xs px-2 py-1 rounded-full bg-green-600';

                // Connect to quantized model
                const quantizedResponse = await fetch(`${quantizedUrl}/models`);
                const quantizedData = await quantizedResponse.json();
                quantizedStats.model = quantizedData.data[0].id;
                quantizedStats.size = quantizedData.data[0].size || 'Unknown';
                quantizedStats.connected = true;

                document.getElementById('quantized-model-name').textContent = quantizedStats.model;
                document.getElementById('quantized-model-size').textContent = quantizedStats.size;
                document.getElementById('quantized-status').textContent = 'Connected';
                document.getElementById('quantized-status').className = 'text-xs px-2 py-1 rounded-full bg-green-600';

                // Clear chat windows and show welcome message
                baselineChat.innerHTML = '';
                quantizedChat.innerHTML = '';

                addMessage(baselineChat, 'assistant', 'Baseline model connected and ready for benchmarking.');
                addMessage(quantizedChat, 'assistant', 'Quantized model connected and ready for benchmarking.');

                // Enable send button
                sendBtn.disabled = false;

                // Update summary
                updateSummaryStats();

                connectBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Connected';
                connectBtn.className = 'w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition cursor-not-allowed';
            } catch (error) {
                console.error('Error connecting to models:', error);
                alert('Error connecting to models. Please check the URLs and try again.');

                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i>Connect to Models';
            }
        }

        // Add message to chat
        function addMessage(chatElement, role, content, isStreaming = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role === 'user' ? 'text-right' : 'text-left'}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `inline-block px-4 py-2 rounded-lg max-w-xs md:max-w-md lg:max-w-lg ${role === 'user' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'}`;

            if (isStreaming) {
                contentDiv.id = `streaming-${chatElement.id}-${Date.now()}`;
                contentDiv.className += ' streaming-content';
            }

            contentDiv.textContent = content;
            messageDiv.appendChild(contentDiv);
            chatElement.appendChild(messageDiv);
            chatElement.scrollTop = chatElement.scrollHeight;

            return contentDiv;
        }

        // Batch request handling
        async function sendBatchRequests(url, messages, temperature, maxTokens, stream, modelType) {
            const concurrentRequests = 1; // fixed batch size 1
            const requests = [];

            // Create array of request promises
            for (let i = 0; i < concurrentRequests; i++) {
                const isFirstRequest = i === 0;
                const contentDiv = isFirstRequest && stream ?
                    document.querySelector(`#${modelType}-chat .streaming-content`) : null;

                const requestPromise = fetch(`${url}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: modelType === 'baseline' ? baselineStats.model : quantizedStats.model,
                        messages: messages,
                        temperature: temperature,
                        max_tokens: maxTokens,
                        stream: stream
                    })
                }).then(async response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const stats = modelType === 'baseline' ? baselineStats : quantizedStats;

                    if (stream) {
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let buffer = '';
                        let firstToken = true;
                        let tokens = 0;

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop();

                            for (const line of lines) {
                                if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                                    try {
                                        const data = JSON.parse(line.substring(6));
                                        if (data.choices && data.choices[0].delta && data.choices[0].delta.content) {
                                            const token = data.choices[0].delta.content;
                                            if (isFirstRequest && contentDiv) {
                                                contentDiv.textContent += token;
                                            }

                                            if (firstToken) {
                                                stats.ttft = Date.now() - stats.startTime;
                                                firstToken = false;
                                            } else {
                                                stats.itl = Date.now() - stats.lastTokenTime;
                                            }

                                            stats.lastTokenTime = Date.now();
                                            tokens++;
                                        }
                                    } catch (e) {
                                        console.error('Error parsing stream data:', e);
                                    }
                                }
                            }
                        }
                        return tokens;
                    } else {
                        const data = await response.json();
                        const content = data.choices[0].message.content;
                        if (isFirstRequest && contentDiv) {
                            contentDiv.textContent = content;
                        }

                        // Estimate tokens for non-streaming
                        const tokens = Math.ceil(content.split(' ').length * 1.33);
                        stats.ttft = Date.now() - stats.startTime;
                        return tokens;
                    }
                });

                requests.push(requestPromise);
            }

            // Wait for all requests to complete and get token counts
            const tokenCounts = await Promise.all(requests);

            // Calculate total tokens and average metrics
            const stats = modelType === 'baseline' ? baselineStats : quantizedStats;
            const totalTokens = tokenCounts.reduce((sum, count) => sum + count, 0);
            const duration = (Date.now() - stats.startTime) / 1000;

            // Update stats
            stats.tokens = totalTokens;
            stats.throughput = totalTokens / duration;

            if (stats.ttft) {
                stats.ttft = stats.ttft / concurrentRequests;
            }
            if (stats.itl) {
                stats.itl = stats.itl / concurrentRequests;
            }

            // Update UI
            document.getElementById(`${modelType}-ttft`).textContent = stats.ttft ? `${stats.ttft.toFixed(0)} ms` : '- ms';
            document.getElementById(`${modelType}-itl`).textContent = stats.itl ? `${stats.itl.toFixed(0)} ms` : '- ms';
            document.getElementById(`${modelType}-throughput`).textContent = `${stats.throughput.toFixed(2)} t/s`;
        }

        // Send message to both models
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || !baselineStats.connected || !quantizedStats.connected) return;

            // Add user message to both chats
            addMessage(baselineChat, 'user', message);
            addMessage(quantizedChat, 'user', message);

            // Clear input
            userInput.value = '';

            // Disable send button during request
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

            // Get parameters
            const temperature = parseFloat(document.getElementById('temperature').value);
            const maxTokens = parseInt(document.getElementById('max-tokens').value);
            const stream = streamToggle.checked;

            // Prepare messages array
            const messages = [
                {
                    role: 'user',
                    content: message
                }
            ];

            // Record start time
            const startTime = Date.now();
            baselineStats.startTime = startTime;
            quantizedStats.startTime = startTime;
            baselineStats.tokens = 0;
            quantizedStats.tokens = 0;
            baselineStats.ttft = null;
            quantizedStats.ttft = null;
            baselineStats.itl = null;
            quantizedStats.itl = null;

            // Create streaming content divs
            if (stream) {
                addMessage(baselineChat, 'assistant', '', true);
                addMessage(quantizedChat, 'assistant', '', true);
            }

            try {
                // Call both models with batch requests
                const baselineUrl = document.getElementById('baseline-url').value;
                const quantizedUrl = document.getElementById('quantized-url').value;

                const baselinePromise = sendBatchRequests(baselineUrl, messages, temperature, maxTokens, stream, 'baseline');
                const quantizedPromise = sendBatchRequests(quantizedUrl, messages, temperature, maxTokens, stream, 'quantized');

                await Promise.all([baselinePromise, quantizedPromise]);

                // Update summary stats
                updateSummaryStats();

            } catch (error) {
                console.error('Error calling models:', error);
                addMessage(baselineChat, 'assistant', 'Error: ' + error.message);
                addMessage(quantizedChat, 'assistant', 'Error: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send';
            }
        }

        // Update summary statistics
        function updateSummaryStats() {
            if (baselineStats.throughput && quantizedStats.throughput) {
                const speedImprovement = ((quantizedStats.throughput - baselineStats.throughput) / baselineStats.throughput * 100).toFixed(2);
                document.getElementById('speed-improvement').textContent = `${speedImprovement}%`;

                // Highlight if significant improvement
                if (parseFloat(speedImprovement) > 10) {
                    document.getElementById('speed-improvement').classList.add('highlight');
                    setTimeout(() => {
                        document.getElementById('speed-improvement').classList.remove('highlight');
                    }, 2000);
                }
            }

            if (baselineStats.ttft && quantizedStats.ttft) {
                const ttftImprovement = ((baselineStats.ttft - quantizedStats.ttft) / baselineStats.ttft * 100).toFixed(2);
                document.getElementById('ttft-improvement').textContent = `${ttftImprovement}%`;
            }

            if (baselineStats.itl && quantizedStats.itl) {
                const itlImprovement = ((baselineStats.itl - quantizedStats.itl) / baselineStats.itl * 100).toFixed(2);
                document.getElementById('itl-improvement').textContent = `${itlImprovement}%`;
            }

            // Update chart with new data point
            if (performanceChart && baselineStats.itl != null && baselineStats.throughput != null) {
                const idx = performanceChart.data.labels.length + 1;
                performanceChart.data.labels.push(idx);
                performanceChart.data.datasets[0].data.push(baselineStats.itl || 0);
                performanceChart.data.datasets[1].data.push(quantizedStats.itl || 0);
                performanceChart.data.datasets[2].data.push(baselineStats.throughput || 0);
                performanceChart.data.datasets[3].data.push(quantizedStats.throughput || 0);
                performanceChart.update();

                // Persist history
                const history = JSON.parse(localStorage.getItem('benchmark_history') || '[]');
                history.push({
                    timestamp: new Date().toLocaleString(),
                    baseline_itl: baselineStats.itl || 0,
                    quantized_itl: quantizedStats.itl || 0,
                    baseline_throughput: baselineStats.throughput || 0,
                    quantized_throughput: quantizedStats.throughput || 0
                });
                localStorage.setItem('benchmark_history', JSON.stringify(history));
            }
        }

        // Reset the application
        function resetApplication() {
            // Reset stats
            baselineStats = {
                model: null,
                size: null,
                connected: false,
                ttft: null,
                itl: null,
                throughput: null,
                tokens: 0,
                startTime: null,
                lastTokenTime: null
            };

            quantizedStats = {
                model: null,
                size: null,
                connected: false,
                ttft: null,
                itl: null,
                throughput: null,
                tokens: 0,
                startTime: null,
                lastTokenTime: null
            };

            // Reset UI
            document.getElementById('baseline-model-name').textContent = 'Baseline Model';
            document.getElementById('baseline-model-size').textContent = '-';
            document.getElementById('baseline-status').textContent = 'Disconnected';
            document.getElementById('baseline-status').className = 'text-xs px-2 py-1 rounded-full bg-gray-600';
            document.getElementById('baseline-ttft').textContent = '- ms';
            document.getElementById('baseline-itl').textContent = '- ms';
            document.getElementById('baseline-throughput').textContent = '- t/s';
            baselineChat.innerHTML = '<div class="text-center text-gray-500 py-10"><i class="fas fa-robot text-4xl mb-2"></i><p>Connect to baseline model to start benchmarking</p></div>';

            document.getElementById('quantized-model-name').textContent = 'Quantized Model';
            document.getElementById('quantized-model-size').textContent = '-';
            document.getElementById('quantized-status').textContent = 'Disconnected';
            document.getElementById('quantized-status').className = 'text-xs px-2 py-1 rounded-full bg-red-600';
            document.getElementById('quantized-ttft').textContent = '- ms';
            document.getElementById('quantized-itl').textContent = '- ms';
            document.getElementById('quantized-throughput').textContent = '- t/s';
            quantizedChat.innerHTML = '<div class="text-center text-red-500 py-10"><i class="fas fa-bolt text-4xl mb-2"></i><p>Connect to quantized model to start benchmarking</p></div>';

            document.getElementById('speed-improvement').textContent = '-';
            document.getElementById('ttft-improvement').textContent = '-';
            document.getElementById('itl-improvement').textContent = '-';
            // memory-reduction removed

            connectBtn.disabled = false;
            connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i>Connect to Models';
            connectBtn.className = 'w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition';

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send';

            // Reset chart data
            if (performanceChart) {
                performanceChart.data.labels = [];
                performanceChart.data.datasets.forEach(ds => { ds.data = []; });
                performanceChart.update();
            }
        }

        // Show history (header button)
        function showHistory() {
            // Switch to History tab
            switchTab('history');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', initPerformanceChart);
        connectBtn.addEventListener('click', connectToModels);
        sendBtn.addEventListener('click', sendMessage);
        resetBtn.addEventListener('click', resetApplication);
        historyBtn.addEventListener('click', showHistory);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Token counter
        userInput.addEventListener('input', () => {
            const text = userInput.value;
            // Very rough token estimate (4 chars ~= 1 token)
            const tokenCount = Math.ceil(text.length / 4);
            document.getElementById('token-count').textContent = tokenCount;
        });
    </script>
</body>

</html>